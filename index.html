<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workload Management System</title>
  <style>
    /* --- CSS Styles --- */
    body { font-family: Arial, sans-serif; margin: 0; text-align: center; background: #f9f9f9; }
    header { background-color: #002147; color: white; padding: 20px; border-bottom: 4px solid #001530; position: relative; }
    header h1, header h2, header h3 { margin: 5px 0; }
    #profileMenu { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); }
    #profileIcon { width: 35px; height: 35px; border-radius: 50%; background: white; color: #002147; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }
    #profileDropdown { display: none; position: absolute; right: 0; margin-top: 5px; background: white; color: #333; border: 1px solid #ccc; border-radius: 5px; text-align: left; min-width: 150px; z-index: 100; }
    #profileDropdown p { margin: 0; padding: 10px; font-size: 14px; border-bottom: 1px solid #eee; }
    #profileDropdown button { width: 100%; border: none; padding: 10px; background: #dc3545; color: white; border-radius: 0 0 5px 5px; cursor: pointer; }
    #profileDropdown button:hover { background: #c82333; }
    select, button { margin: 5px; padding: 8px 12px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #28a745; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background-color: #218838; }
    #summary { margin-top: 30px; border-collapse: collapse; width: 100%; }
    #summary th { background-color: #002147; color: white; padding: 10px; border: 1px solid #ddd; }
    #summary td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    #buttonRow { margin: 20px 0; }
    #printArea { margin-top: 20px; }
    footer { margin: 30px 0; font-size: 14px; color: #555; }
    
    /* Login & Multi-select */
    #loginScreen header { background-color: #002147; color: white; padding: 20px; border-bottom: 4px solid #001530; }
    #loginBox { margin: 50px auto; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 10px; width: 300px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #loginBox input { margin: 5px; padding: 8px; width: 90%; font-size: 14px; }
    #loginError { color: red; }
    .multi-select-container { display: inline-block; position: relative; min-width: 180px; margin: 5px; }
    .select-box { background-color: white; padding: 8px 12px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; height: 18px; }
    .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 100%; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 5px; max-height: 250px; overflow-y: auto; text-align: left; padding: 5px 0; }
    .dropdown-content label { display: block; padding: 5px 10px; cursor: pointer; white-space: nowrap; }
    .dropdown-content label:hover { background-color: #ddd; }
    
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; color: #000 !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
      #printHeading { font-size: 22px !important; font-weight: 900 !important; text-decoration: underline; margin-bottom: 20px; text-align: center; color: #000 !important; }
      #summary { border-collapse: collapse !important; width: 100%; border: 2px solid #000 !important; }
      #summary th, #summary td { border: 1px solid #000 !important; padding: 8px; }
      #summary th { background-color: transparent !important; color: #000 !important; font-weight: bold !important; border-bottom: 2px solid #000 !important; }
      footer.no-print, #profileMenu, #buttonRow, header { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>
    </header>
    <div id="loginBox">
      <h2>Please Login</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <br>
      <button onclick="checkLogin()">Login</button>
      <p id="loginError"></p>
    </div>
    <footer class="no-print">Developed by <b>Umair Shahzad</b></footer>
  </div>

  <div id="mainContent" style="display:none;">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>
      <div id="profileMenu">
        <div id="profileIcon" onclick="toggleProfileMenu()">U</div>
        <div id="profileDropdown">
          <p id="loggedUser"></p>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <div style="margin-top:20px;">
      <label>Select Years:</label>
      <div class="multi-select-container">
          <div class="select-box" onclick="toggleDropdown('yearDropdown')">
              <span id="selectedYearsText">Select Years</span><span class="arrow">&#9662;</span>
          </div>
          <div id="yearDropdown" class="dropdown-content">
              <label><input type="checkbox" id="selectAllYears" onchange="toggleSelectAll('yearDropdown', 'year-checkbox')"> Select All</label>
              <hr style="margin: 5px 0; border-top: 1px solid #eee;">
          </div>
      </div>
      
      <label>Ministry:</label>
      <div class="multi-select-container">
          <div class="select-box" onclick="toggleDropdown('ministryDropdown')">
              <span id="selectedMinistriesText">Select Ministries</span><span class="arrow">&#9662;</span>
          </div>
          <div id="ministryDropdown" class="dropdown-content">
              <label><input type="checkbox" id="selectAllMinistries" onchange="toggleSelectAll('ministryDropdown', 'ministry-checkbox')"> Select All</label>
              <hr style="margin: 5px 0; border-top: 1px solid #eee;">
          </div>
      </div>
    </div>

    <div id="buttonRow">
      <button onclick="loadSummary()">Summary</button>
      <button onclick="loadDACSettled()">Settled in DAC</button>
      <button onclick="loadPendingSplit()">Workload (Detailed)</button>
      <button onclick="loadPACMIWorkload()">Workload (M&I)</button>
      <button onclick="loadPACProgress()">Status for PAC</button>
      <button onclick="loadComplianceReport()">Compliance Report</button> 
      
      <button onclick="printTable()">Print</button>
      <button onclick="downloadExcel()">Excel</button>
      <button onclick="downloadPDF()">PDF</button>
    </div>

    <div id="printArea">
      <div id="printHeading"></div>
      <table id="summary"></table>
    </div>

    <footer class="no-print">Developed by <b>Umair Shahzad</b></footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    // --- IMPORTANT: REPLACE THIS URL AFTER DEPLOYMENT ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyT1KwVvgbjdQkoOh_LWs_ny_X4zY_BooD2bJ0GWaVmjg3E7TcqNmDibTQOR8Wn9W56/exec"; 
    // ----------------------------------------------------

    let allYears = [];
    let currentView = "";
    let logoutTimer;

    // --- UTILITIES ---
    function checkLogin() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      if (u === "dgcaisb.pac" && p === "pac09876") {
        document.getElementById("loginScreen").style.display="none";
        document.getElementById("mainContent").style.display="block";
        document.getElementById("loggedUser").innerText = "Logged in as: " + u;
        resetLogoutTimer();
        loadYears();
      } else { document.getElementById("loginError").innerText = "Invalid Credentials"; }
    }
    function logout() { location.reload(); }
    function resetLogoutTimer() { clearTimeout(logoutTimer); logoutTimer = setTimeout(logout, 30*60*1000); }
    document.onmousemove = resetLogoutTimer; document.onkeypress = resetLogoutTimer;

    function toggleProfileMenu() { const m = document.getElementById("profileDropdown"); m.style.display = m.style.display==="block"?"none":"block"; }
    function toggleDropdown(id) { document.getElementById(id).style.display = document.getElementById(id).style.display==="block"?"none":"block"; }
    window.onclick = function(e) { if(!e.target.closest('.multi-select-container')) { document.querySelectorAll('.dropdown-content').forEach(d=>d.style.display='none'); } }

    function toggleSelectAll(ddId, cls) {
      const master = document.getElementById(ddId).querySelector('input[type="checkbox"]');
      document.getElementById(ddId).querySelectorAll('.'+cls).forEach(cb => cb.checked = master.checked);
      updateSelectedText(ddId, cls==='year-checkbox'?'selectedYearsText':'selectedMinistriesText', cls);
    }
    
    function updateSelectedText(ddId, txtId, cls) {
      const cbs = document.getElementById(ddId).querySelectorAll('.'+cls);
      const sel = Array.from(cbs).filter(c=>c.checked).map(c=>c.value);
      let text = "None";
      if (sel.length === 0) text = "None Selected";
      else if (sel.length === cbs.length && cbs.length > 0) text = "All Selected (" + sel.length + ")"; 
      else text = sel.length + " Selected";
      document.getElementById(txtId).innerText = text;
      if(cls==='year-checkbox') loadMinistries();
    }
    function getSelectedValues(cls) {
       const dd = cls==='year-checkbox'?'yearDropdown':'ministryDropdown';
       return Array.from(document.getElementById(dd).querySelectorAll('.'+cls)).filter(c=>c.checked).map(c=>c.value).join('|||');
    }

    // --- API & DATA ---
    async function fetchData(action, params={}) {
      const url = new URL(API_URL);
      url.search = new URLSearchParams({action:action, ...params});
      try {
        const res = await fetch(url);
        return await res.json();
      } catch(e) { alert("Data Fetch Error. Check Internet or API URL."); return []; }
    }

    async function loadYears() {
      const data = await fetchData("getYears");
      const dd = document.getElementById("yearDropdown");
      const base = dd.innerHTML.split('<hr')[0] + '<hr style="margin:5px 0;border-top:1px solid #eee;">'; 
      dd.innerHTML = base;
      data.forEach(y => {
        const l = document.createElement('label');
        l.innerHTML = `<input type="checkbox" class="year-checkbox" value="${y}" onchange="updateSelectedText('yearDropdown', 'selectedYearsText', 'year-checkbox')"> ${y}`;
        dd.appendChild(l);
      });
      const selectAllBox = document.getElementById('selectAllYears');
      if(selectAllBox) { selectAllBox.checked = true; toggleSelectAll('yearDropdown', 'year-checkbox'); }
    }

    async function loadMinistries() {
      const years = getSelectedValues('year-checkbox');
      const dd = document.getElementById("ministryDropdown");
      const baseHTML = dd.innerHTML.split('<hr')[0] + '<hr style="margin:5px 0;border-top:1px solid #eee;">'; 
      if(!years) { dd.innerHTML = baseHTML; document.getElementById("selectedMinistriesText").innerText = "None"; return; }
      const data = await fetchData("getMinistries", {years:years});
      dd.innerHTML = baseHTML;
      if(data.length === 0) { document.getElementById("selectedMinistriesText").innerText = "None"; return; }
      data.forEach(m => {
        const l = document.createElement('label');
        l.innerHTML = `<input type="checkbox" class="ministry-checkbox" value="${m}" onchange="updateSelectedText('ministryDropdown', 'selectedMinistriesText', 'ministry-checkbox')"> ${m}`;
        dd.appendChild(l);
      });
      const selectAllBox = document.getElementById('selectAllMinistries');
      if(selectAllBox) { selectAllBox.checked = true; toggleSelectAll('ministryDropdown', 'ministry-checkbox'); }
    }

    // --- REPORTS ---
    async function loadSummary() {
      const yrs = getSelectedValues('year-checkbox'), mins = getSelectedValues('ministry-checkbox');
      if(!yrs || !mins) return alert("Select Year & Ministry");
      const data = await fetchData("generateSummary", {years:yrs, ministries:mins});
      currentView = "summary";
      document.getElementById("printHeading").innerText = "Workload Summary";
      let html = `<tr><th>Year</th><th>Ministry</th><th>Department</th><th>Total Paras</th><th>PAC Settled</th><th>DAC Settled</th><th>Pending</th><th>Pending Para Nos</th></tr>`;
      let t = {tot:0, pac:0, dac:0, pen:0};
      data.forEach(r => {
        const pendCount = parseInt(r[6]||0) + parseInt(r[8]||0);
        const pendNos = [r[7], r[9]].filter(x=>x).join(", ");
        html += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${pendCount}</td><td>${pendNos}</td></tr>`;
        t.tot+=parseInt(r[3]); t.pac+=parseInt(r[4]); t.dac+=parseInt(r[5]); t.pen+=pendCount;
      });
      html += `<tr style="font-weight:bold;background:#eee;"><td colspan="3" align="right">Total</td><td>${t.tot}</td><td>${t.pac}</td><td>${t.dac}</td><td>${t.pen}</td><td></td></tr>`;
      document.getElementById("summary").innerHTML = html;
    }

    async function loadPendingSplit() {
      const yrs = getSelectedValues('year-checkbox'), mins = getSelectedValues('ministry-checkbox');
      if(!yrs || !mins) return alert("Select Year & Ministry");
      const data = await fetchData("generateSummary", {years:yrs, ministries:mins});
      currentView = "detailed";
      document.getElementById("printHeading").innerText = "Workload Detailed";
      let html = `<tr><th>Year</th><th>Ministry</th><th>Entity</th><th>Total</th><th>PAC Settled</th><th>DAC Settled</th><th>Audit Paras</th><th>Audit Para Nos</th><th>Comments</th><th>Comment Nos</th></tr>`;
      let t = {tot:0, pac:0, dac:0, aud:0, com:0};
      data.forEach(r => {
        html += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td>${r[9]}</td></tr>`;
        t.tot+=parseInt(r[3]); t.pac+=parseInt(r[4]); t.dac+=parseInt(r[5]); t.aud+=parseInt(r[6]); t.com+=parseInt(r[8]);
      });
      html += `<tr style="font-weight:bold;background:#eee;"><td colspan="3" align="right">Total</td><td>${t.tot}</td><td>${t.pac}</td><td>${t.dac}</td><td>${t.aud}</td><td></td><td>${t.com}</td><td></td></tr>`;
      document.getElementById("summary").innerHTML = html;
    }

    async function loadDACSettled() {
      const yrs = getSelectedValues('year-checkbox'), mins = getSelectedValues('ministry-checkbox');
      if(!yrs || !mins) return alert("Select Year & Ministry");
      const data = await fetchData("dacSettled", {years:yrs, ministries:mins});
      currentView = "dac";
      document.getElementById("printHeading").innerText = "Paras Settled in DAC";
      if(!data.length) { document.getElementById("summary").innerHTML = "<tr><td>No Data Found</td></tr>"; return; }
      let html = `<tr><th>Year</th><th>Ministry</th><th>Entity</th><th>Date of DAC</th><th>Paras Settled</th><th>Settled Para Nos</th></tr>`;
      let tot = 0;
      data.forEach(r => {
        html += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`;
        tot += parseInt(r[4]);
      });
      html += `<tr style="font-weight:bold;background:#eee;"><td colspan="4" align="right">Total</td><td>${tot}</td><td></td></tr>`;
      document.getElementById("summary").innerHTML = html;
    }

    async function loadPACProgress() {
      const yrs = getSelectedValues('year-checkbox'), mins = getSelectedValues('ministry-checkbox');
      if(!yrs || !mins) return alert("Select Year & Ministry");
      const data = await fetchData("generatePACProgress", {years:yrs, ministries:mins});
      currentView = "pac_status";
      document.getElementById("printHeading").innerText = "PAC Status Report";
      let html = `<tr><th>Year</th><th>Ministry</th><th>Entity</th><th>Total Paras</th><th>Discussed</th><th>PAC Settled</th><th>DAC Rec.</th><th>Court/FIA</th><th>Pending Disc.</th></tr>`;
      let t = Array(6).fill(0);
      data.forEach(r => {
        html += `<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`;
        for(let i=3; i<9; i++) t[i-3] += parseInt(r[i]||0);
      });
      html += `<tr style="font-weight:bold;background:#eee;"><td colspan="3" align="right">Total</td><td>${t[0]}</td><td>${t[1]}</td><td>${t[2]}</td><td>${t[3]}</td><td>${t[4]}</td><td>${t[5]}</td></tr>`;
      document.getElementById("summary").innerHTML = html;
    }

    async function loadPACMIWorkload() {
       const yrs = getSelectedValues('year-checkbox');
       const mins = getSelectedValues('ministry-checkbox');
       if(!yrs || !mins) { alert("Please select Year and Ministry"); return; }
       const data = await fetchData("generatePACMIWorkload", {years:yrs, ministries:mins});
       currentView = "pac_mi";
       document.getElementById("printHeading").innerText = "Workload (Monitoring & Implementation)";
       let html = `<tr><th>Year</th><th>Ministry</th><th>Entity</th><th>Total Paras</th><th>PAC Settled</th><th>DAC Settled</th><th>Pending Paras</th><th>Pending for PAC Compliance</th><th>Pending for PAC Compliance Nos</th></tr>`;
       let t = {tot:0, pac:0, dac:0, pen:0, mi:0};
       data.forEach(r => {
         html += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td></tr>`;
         t.tot += parseInt(r[3]||0); t.pac += parseInt(r[4]||0); t.dac += parseInt(r[5]||0); t.pen += parseInt(r[6]||0); t.mi  += parseInt(r[7]||0);
       });
       html += `<tr style="font-weight:bold;background:#eee;"><td colspan="3" align="right">Total</td><td>${t.tot}</td><td>${t.pac}</td><td>${t.dac}</td><td>${t.pen}</td><td>${t.mi}</td><td></td></tr>`;
       document.getElementById("summary").innerHTML = html;
    }

    // --- NEW: COMPLIANCE REPORT FUNCTION ---
    async function loadComplianceReport() {
      const yrs = getSelectedValues('year-checkbox');
      const mins = getSelectedValues('ministry-checkbox');
      if(!yrs || !mins) { alert("Please select Year and Ministry"); return; }

      const data = await fetchData("generateComplianceReport", {years:yrs, ministries:mins});
      currentView = "compliance";
      document.getElementById("printHeading").innerText = "Compliance of PAC Directives)";
      
      let html = `<tr>
            <th>Audit Year</th>
            <th>Ministry</th>
            <th>Department</th>
            <th>Total Paras</th>
            <th>Full Compliance</th>
            <th>Partial Compliance</th>
            <th>Pending for Compliance</th>
            <th>Pending Paras No.</th>
            <th>% of Compliance</th>
        </tr>`;

      let t = {tot:0, full:0, part:0, pend:0};

      if(data.length === 0) {
         document.getElementById("summary").innerHTML = "<tr><td colspan='9'>No Discussed Paras Found</td></tr>";
         return;
      }

      data.forEach(r => {
        html += `<tr>
                <td>${r[0]}</td>
                <td>${r[1]}</td>
                <td>${r[2]}</td>
                <td>${r[3]}</td>
                <td>${r[4]}</td>
                <td>${r[5]}</td>
                <td>${r[6]}</td>
                <td style="font-size:12px;">${r[7]}</td>
                <td><b>${r[8]}%</b></td>
            </tr>`;
        t.tot += parseInt(r[3]||0);
        t.full += parseInt(r[4]||0);
        t.part += parseInt(r[5]||0);
        t.pend += parseInt(r[6]||0);
      });

      let totalPerc = t.tot > 0 ? ((t.full / t.tot) * 100).toFixed(2) : "0.00";
      html += `<tr style="font-weight:bold;background:#eee;">
            <td colspan="3" align="right">Total</td>
            <td>${t.tot}</td>
            <td>${t.full}</td>
            <td>${t.part}</td>
            <td>${t.pend}</td>
            <td></td>
            <td>${totalPerc}%</td>
        </tr>`;
      document.getElementById("summary").innerHTML = html;
    }

    // --- DOWNLOADS ---
    function printTable() { window.print(); }
    function downloadExcel() {
      const wb = XLSX.utils.table_to_book(document.getElementById("summary"), {sheet:"Sheet1"});
      XLSX.writeFile(wb, "Report.xlsx");
    }
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'pt', 'a4');
      doc.text(document.getElementById("printHeading").innerText, 40, 30);
      doc.autoTable({ html: '#summary', startY: 50 });
      doc.save("Report.pdf");
    }
  </script>
</body>
</html>
