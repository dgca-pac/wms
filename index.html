<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workload Management System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      text-align: center;
      background: #f9f9f9;
    }
    header {
      background-color: #002147;
      color: white;
      padding: 20px;
      border-bottom: 4px solid #001530;
      position: relative;
    }
    header h1, header h2, header h3 {
      margin: 5px 0;
    }

    /* Profile icon centered vertically */
    #profileMenu {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    #profileIcon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: white;
      color: #002147;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
    }
    #profileDropdown {
      display: none;
      position: absolute;
      right: 0;
      margin-top: 5px;
      background: white;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: left;
      min-width: 150px;
      z-index: 100;
    }
    #profileDropdown p {
      margin: 0;
      padding: 10px;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    #profileDropdown button {
      width: 100%;
      border: none;
      padding: 10px;
      background: #dc3545;
      color: white;
      border-radius: 0 0 5px 5px;
      cursor: pointer;
    }
    #profileDropdown button:hover {
      background: #c82333;
    }

    select, button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #218838;
    }
    #summary {
      margin-top: 30px;
      border-collapse: collapse;
      width: 100%;
    }
    #summary th {
      background-color: #002147;
      color: white;
      padding: 10px;
      border: 1px solid #ddd;
    }
    #summary td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #buttonRow {
      margin: 20px 0;
    }
    #buttonRow button {
      margin: 0 5px;
    }
    #printArea {
      margin-top: 20px;
    }
    footer {
      margin: 30px 0;
      font-size: 14px;
      color: #555;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen header {
      background-color: #002147;
      color: white;
      padding: 20px;
      border-bottom: 4px solid #001530;
    }
    #loginBox {
      margin: 50px auto;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #loginBox input {
      margin: 5px;
      padding: 8px;
      width: 90%;
      font-size: 14px;
    }
    #loginBox button {
      margin-top: 10px;
    }
    #loginError { color: red; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      #printHeading {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      footer.no-print, #profileMenu { display: none; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>
    </header>

    <div id="loginBox">
      <h2>Please Login</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <br>
      <button onclick="checkLogin()">Login</button>
      <p id="loginError"></p>
    </div>

    <footer class="no-print">
      Developed by <b>Umair Shahzad</b>
    </footer>
  </div>

  <!-- Main Content -->
  <div id="mainContent" style="display:none;">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>

      <!-- Profile Menu -->
      <div id="profileMenu">
        <div id="profileIcon" onclick="toggleProfileMenu()">U</div>
        <div id="profileDropdown">
          <p id="loggedUser"></p>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <div style="margin-top:20px;">
      <label for="fromYear">From Year:</label>
      <select id="fromYear"></select>
      <label for="toYear">To Year:</label>
      <select id="toYear"></select>
      <label for="ministry">Ministry:</label>
      <select id="ministry"></select>
    </div>

    <div id="buttonRow">
      <button onclick="loadSummary()">Generate Summary</button>
      <button onclick="loadDACSettled()">Settled in DAC</button>
      <button onclick="loadPendingSplit()">Workload Summary (Detailed)</button>
      <button onclick="printTable()">Print</button>
      <button onclick="downloadExcel()">Download Excel</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <div id="printArea">
      <div id="printHeading"></div>
      <table id="summary"></table>
    </div>

    <footer class="no-print">
      Developed by <b>Umair Shahzad</b>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9tqjPBkPaCMqkLD76iZ_Y3go2JkyUa8GRRkP9NErxDi1dx0I3hmL6rlEswXYYXf8q/exec";
    let allYears = [];
    let currentView = "";
    let logoutTimer;

    // --- LOGIN SYSTEM ---
    function checkLogin() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;

      if (user === "dgcaisb.pac" && pass === "pac09876") {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loggedUser").innerText = "Logged in as: " + user;
        resetLogoutTimer();
        loadYears(); // fresh load
      } else {
        document.getElementById("loginError").innerText = "Invalid Username or Password!";
      }
    }

    function logout() {
      document.getElementById("loginScreen").style.display = "block";
      document.getElementById("mainContent").style.display = "none";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("loginError").innerText = "";
      clearTimeout(logoutTimer);
    }

    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        alert("Session expired due to inactivity. Logging out...");
        logout();
      }, 30 * 60 * 1000); // 30 minutes
    }

    document.onmousemove = resetLogoutTimer;
    document.onkeypress = resetLogoutTimer;

    // --- PROFILE MENU ---
    function toggleProfileMenu() {
      const menu = document.getElementById("profileDropdown");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }
    window.onclick = function(event) {
      if (!event.target.matches('#profileIcon')) {
        document.getElementById("profileDropdown").style.display = "none";
      }
    }

    // --- EXISTING FUNCTIONS ---
    async function fetchData(endpoint, params={}) {
      const url = new URL(API_URL);
      url.search = new URLSearchParams({action:endpoint, ...params});
      const res = await fetch(url);
      return res.json();
    }

    async function loadYears() {
      allYears = await fetchData("getYears");
      const fromSelect = document.getElementById("fromYear");
      const toSelect = document.getElementById("toYear");
      fromSelect.innerHTML = allYears.map(y => `<option>${y}</option>`).join("");
      toSelect.innerHTML = allYears.map(y => `<option>${y}</option>`).join("");
      await loadMinistries();
    }

    function updateToYear() {
      const fromYear = document.getElementById("fromYear").value;
      const fromIndex = allYears.indexOf(fromYear);
      const toSelect = document.getElementById("toYear");
      toSelect.innerHTML = allYears.slice(fromIndex).map(y => `<option>${y}</option>`).join("");
    }

    async function loadMinistries() {
      const fromYear = document.getElementById("fromYear").value;
      const toYear = document.getElementById("toYear").value;
      if (!fromYear || !toYear) return;
      const ministries = await fetchData("getMinistries", {fromYear, toYear});
      const minSelect = document.getElementById("ministry");
      minSelect.innerHTML = ministries.map(m => `<option>${m}</option>`).join("");
    }

    // --- Updated loadSummary() with TOTAL skip ---
    async function loadSummary() {
      const fromYear = document.getElementById("fromYear").value;
      const toYear = document.getElementById("toYear").value;
      const ministry = document.getElementById("ministry").value;
      if (!fromYear || !toYear || !ministry) return;
      const data = await fetchData("generateSummary", {fromYear, toYear, ministry});
      const table = document.getElementById("summary");
      currentView = "summary";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='8'>No Data Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Workload Summary";

      let totals = { total:0, pac:0, dac:0, pending:0 };

      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Department</th>
          <th>Total Paras</th>
          <th>PAC Settled</th>
          <th>DAC Settled</th>
          <th>Pending</th>
          <th>Pending Para Nos</th>
        </tr>
      `;

      data.forEach(r => {
        if ((r[0] || "").toUpperCase().includes("TOTAL") || (r[1] || "").toUpperCase().includes("TOTAL")) return;
        table.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        totals.total += parseInt(r[3]||0);
        totals.pac += parseInt(r[4]||0);
        totals.dac += parseInt(r[5]||0);
        totals.pending += parseInt(r[6]||0);
      });

      table.innerHTML += `
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="3" style="text-align:right">Total</td>
          <td>${totals.total}</td>
          <td>${totals.pac}</td>
          <td>${totals.dac}</td>
          <td>${totals.pending}</td>
          <td></td>
        </tr>
      `;
    }

    // --- Updated loadPendingSplit() with TOTAL skip ---
    async function loadPendingSplit() {
      const fromYear = document.getElementById("fromYear").value;
      const toYear = document.getElementById("toYear").value;
      const ministry = document.getElementById("ministry").value;
      if (!fromYear || !toYear || !ministry) return;

      const data = await fetchData("generateSummary", {fromYear, toYear, ministry});
      const table = document.getElementById("summary");
      currentView = "pendingSplit";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='10'>No Data Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Workload Summary (Detailed)";

      let totals = { total:0, pac:0, dac:0, pAudit:0, pComments:0 };

      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Entity</th>
          <th>Total Paras</th>
          <th>PAC Settled</th>
          <th>DAC Settled</th>
          <th>Pending Audit Paras</th>
          <th>Pending Audit Paras Nos</th>
          <th>Pending Audit Comments</th>
          <th>Pending Audit Comments Nos</th>
        </tr>
      `;

      data.forEach(r => {
        if ((r[0] || "").toUpperCase().includes("TOTAL") || (r[1] || "").toUpperCase().includes("TOTAL")) return;

        const year = r[0], min = r[1], dept = r[2];
        const total = parseInt(r[3]||0), pac = parseInt(r[4]||0), dac = parseInt(r[5]||0);
        let pendingNos = (r[7]||"").split(",").map(p=>p.trim()).filter(p=>p);

        let pAudit = [], pComments = [];
        pendingNos.forEach(p=>{
          if (/^\d+(\.\d+)*\.4\.\d+$/.test(p)) {
            pAudit.push(p);
          } else {
            pComments.push(p);
          }
        });

        table.innerHTML += `
          <tr>
            <td>${year}</td>
            <td>${min}</td>
            <td>${dept}</td>
            <td>${total}</td>
            <td>${pac}</td>
            <td>${dac}</td>
            <td>${pAudit.length}</td>
            <td>${pAudit.join(", ")}</td>
            <td>${pComments.length}</td>
            <td>${pComments.join(", ")}</td>
          </tr>
        `;

        totals.total += total; totals.pac += pac; totals.dac += dac;
        totals.pAudit += pAudit.length; totals.pComments += pComments.length;
      });

      table.innerHTML += `
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="3" style="text-align:right">Total</td>
          <td>${totals.total}</td>
          <td>${totals.pac}</td>
          <td>${totals.dac}</td>
          <td>${totals.pAudit}</td>
          <td></td>
          <td>${totals.pComments}</td>
          <td></td>
        </tr>
      `;
    }

    async function loadDACSettled() {
      const fromYear = document.getElementById("fromYear").value;
      const toYear = document.getElementById("toYear").value;
      const ministry = document.getElementById("ministry").value;
      if (!fromYear || !toYear || !ministry) return;

      const data = await fetchData("dacSettled", {fromYear, toYear, ministry});
      const table = document.getElementById("summary");
      currentView = "dac";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='6'>No DAC Settled Paras Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Summary of Paras Settled in DAC";

      let totalDAC = 0;
      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Entity</th>
          <th>Date of DAC</th>
          <th>Paras Settled in DAC</th>
          <th>Settled Para Nos</th>
        </tr>
        ${data.map(r => {
          totalDAC += parseInt(r[4] || 0, 10);
          return `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        }).join("")}
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="4" style="text-align:right">Total</td>
          <td>${totalDAC}</td>
          <td></td>
        </tr>
      `;
    }

    function printTable() { window.print(); }

    function downloadExcel() {
      const table = document.getElementById("summary");
      const wb = XLSX.utils.table_to_book(table, {sheet:"Summary"});
      let filename = "Workload_Summary.xlsx";
      if (currentView === "dac") filename = "DAC_Settled_Summary.xlsx";
      if (currentView === "pendingSplit") filename = "Workload_Detailed_Summary.xlsx";
      XLSX.writeFile(wb, filename);
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'pt', 'a4');
      const title = document.getElementById("printHeading").innerText;
      doc.text(title, 40, 30);
      doc.autoTable({ html: '#summary', startY: 50 });
      let filename = "Workload_Summary.pdf";
      if (currentView === "dac") filename = "DAC_Settled_Summary.pdf";
      if (currentView === "pendingSplit") filename = "Workload_Detailed_Summary.pdf";
      doc.save(filename);
    }

    document.getElementById("fromYear").addEventListener("change", () => {
      updateToYear();
      loadMinistries();
    });
    document.getElementById("toYear").addEventListener("change", loadMinistries);
  </script>
</body>
</html>

