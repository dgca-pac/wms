<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workload Management System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      text-align: center;
      background: #f9f9f9;
    }
    header {
      background-color: #002147;
      color: white;
      padding: 20px;
      border-bottom: 4px solid #001530;
      position: relative;
    }
    header h1, header h2, header h3 {
      margin: 5px 0;
    }

    /* Profile icon centered vertically */
    #profileMenu {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    #profileIcon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: white;
      color: #002147;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
    }
    #profileDropdown {
      display: none;
      position: absolute;
      right: 0;
      margin-top: 5px;
      background: white;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: left;
      min-width: 150px;
      z-index: 100;
    }
    #profileDropdown p {
      margin: 0;
      padding: 10px;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    #profileDropdown button {
      width: 100%;
      border: none;
      padding: 10px;
      background: #dc3545;
      color: white;
      border-radius: 0 0 5px 5px;
      cursor: pointer;
    }
    #profileDropdown button:hover {
      background: #c82333;
    }

    select, button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #218838;
    }
    #summary {
      margin-top: 30px;
      border-collapse: collapse;
      width: 100%;
    }
    #summary th {
      background-color: #002147;
      color: white;
      padding: 10px;
      border: 1px solid #ddd;
    }
    #summary td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #buttonRow {
      margin: 20px 0;
    }
    #buttonRow button {
      margin: 0 5px;
    }
    #printArea {
      margin-top: 20px;
    }
    footer {
      margin: 30px 0;
      font-size: 14px;
      color: #555;
    }

    /* --- LOGIN SCREEN --- */
    #loginScreen header {
      background-color: #002147;
      color: white;
      padding: 20px;
      border-bottom: 4px solid #001530;
    }
    #loginBox {
      margin: 50px auto;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #loginBox input {
      margin: 5px;
      padding: 8px;
      width: 90%;
      font-size: 14px;
    }
    #loginBox button {
      margin-top: 10px;
    }
    #loginError { color: red; }

    /* --- Multi-select Styles (New) --- */
    .multi-select-container {
      display: inline-block;
      position: relative;
      min-width: 180px;
      margin: 5px;
    }
    .select-box {
      background-color: white;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 18px; 
    }
    .arrow {
      margin-left: 10px;
      font-size: 10px;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 100%;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 10; 
      border-radius: 5px;
      max-height: 250px; 
      overflow-y: auto; 
      text-align: left;
      padding: 5px 0;
    }
    .dropdown-content label {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
      white-space: nowrap;
    }
    .dropdown-content label:hover {
      background-color: #ddd;
    }
    .dropdown-content input[type="checkbox"] {
      margin-right: 5px;
    }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      #printHeading {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      footer.no-print, #profileMenu { display: none; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>
    </header>

    <div id="loginBox">
      <h2>Please Login</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <br>
      <button onclick="checkLogin()">Login</button>
      <p id="loginError"></p>
    </div>

    <footer class="no-print">
      Developed by <b>Umair Shahzad</b>
    </footer>
  </div>

  <!-- Main Content -->
  <div id="mainContent" style="display:none;">
    <header>
      <h1>Directorate General, Commercial Audit & Evaluation (North), Islamabad</h1>
      <h2>PAC Section</h2>
      <h3>Workload Management System</h3>

      <!-- Profile Menu -->
      <div id="profileMenu">
        <div id="profileIcon" onclick="toggleProfileMenu()">U</div>
        <div id="profileDropdown">
          <p id="loggedUser"></p>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <div style="margin-top:20px;">
      <!-- START: Multi-select Year Dropdown -->
      <label for="yearSelect">Select Years:</label>
      <div id="yearSelectContainer" class="multi-select-container">
          <div class="select-box" onclick="toggleDropdown('yearDropdown')">
              <span id="selectedYearsText">Select Years</span>
              <span class="arrow">&#9662;</span>
          </div>
          <div id="yearDropdown" class="dropdown-content">
              <label><input type="checkbox" id="selectAllYears" onchange="toggleSelectAll('yearDropdown', 'year-checkbox')"> Select All</label>
              <hr style="margin: 5px 0; border-top: 1px solid #eee;">
          </div>
      </div>
      <!-- END: Multi-select Year Dropdown -->

      <!-- START: Multi-select Ministry Dropdown -->
      <label for="ministrySelect">Ministry:</label>
      <div id="ministrySelectContainer" class="multi-select-container">
          <div class="select-box" onclick="toggleDropdown('ministryDropdown')">
              <span id="selectedMinistriesText">Select Ministries</span>
              <span class="arrow">&#9662;</span>
          </div>
          <div id="ministryDropdown" class="dropdown-content">
              <label><input type="checkbox" id="selectAllMinistries" onchange="toggleSelectAll('ministryDropdown', 'ministry-checkbox')"> Select All</label>
              <hr style="margin: 5px 0; border-top: 1px solid #eee;">
          </div>
      </div>
      <!-- END: Multi-select Ministry Dropdown -->
    </div>

    <div id="buttonRow">
      <button onclick="loadPACProgress()">PAC Status Report (New)</button> 
      <button onclick="loadSummary()">Generate Summary</button>
      <button onclick="loadDACSettled()">Settled in DAC</button>
      <button onclick="loadPendingSplit()">Workload Summary (Detailed)</button>
      <button onclick="printTable()">Print</button>
      <button onclick="downloadExcel()">Download Excel</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <div id="printArea">
      <div id="printHeading"></div>
      <table id="summary"></table>
    </div>

    <footer class="no-print">
      Developed by <b>Umair Shahzad</b>
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyTPmR3a1TtYFtcKiIKpQELp1bJwO_8gUaFHIgKrIdzx0hYILBJ4_PT6X9uN81KGFr8/exec";
    let allYears = [];
    let allMinistries = [];
    let currentView = "";
    let logoutTimer;

    // --- LOGIN SYSTEM ---
    function checkLogin() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;

      if (user === "dgcaisb.pac" && pass === "pac09876") {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loggedUser").innerText = "Logged in as: " + user;
        resetLogoutTimer();
        loadYears(); // fresh load
      } else {
        document.getElementById("loginError").innerText = "Invalid Username or Password!";
      }
    }

    function logout() {
      document.getElementById("loginScreen").style.display = "block";
      document.getElementById("mainContent").style.display = "none";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      document.getElementById("loginError").innerText = "";
      clearTimeout(logoutTimer);
    }

    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        showAppMessage("Session expired due to inactivity. Logging out...");
        logout();
      }, 30 * 60 * 1000); // 30 minutes
    }
    
    function showAppMessage(message) {
      console.error("App Message (Error/Alert):", message);
    }

    document.onmousemove = resetLogoutTimer;
    document.onkeypress = resetLogoutTimer;

    // --- PROFILE MENU ---
    function toggleProfileMenu() {
      const menu = document.getElementById("profileDropdown");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }
    
    // --- MULTI-SELECT HANDLERS (Delimiter Fix: using '|||' instead of ',') ---
    function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const otherDropdownId = (dropdownId === 'yearDropdown') ? 'ministryDropdown' : 'yearDropdown';
        if (document.getElementById(otherDropdownId)) {
            document.getElementById(otherDropdownId).style.display = 'none';
        }

        dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
    }

    function toggleSelectAll(dropdownId, checkboxClass) {
        const dropdown = document.getElementById(dropdownId);
        const masterCheckbox = dropdown.querySelector(`#selectAll${checkboxClass === 'year-checkbox' ? 'Years' : 'Ministries'}`);
        const checkboxes = dropdown.querySelectorAll(`.${checkboxClass}`);
        
        checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
        });

        const textElementId = checkboxClass === 'year-checkbox' ? 'selectedYearsText' : 'selectedMinistriesText';
        updateSelectedText(dropdownId, textElementId, checkboxClass);
    }

    function updateSelectedText(dropdownId, textElementId, checkboxClass) {
        const checkboxes = document.getElementById(dropdownId).querySelectorAll(`.${checkboxClass}`);
        const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        const textElement = document.getElementById(textElementId);
        
        if (selected.length === 0) {
            textElement.innerText = `None Selected`;
        } else if (selected.length === checkboxes.length && checkboxes.length > 0) {
            textElement.innerText = `All Selected (${selected.length})`;
        } else if (selected.length > 3) {
            textElement.innerText = `${selected.length} Selected`;
        } else {
            textElement.innerText = selected.join(', ');
        }
        
        if (checkboxClass === 'year-checkbox') {
            loadMinistries();
        }
    }

    // IMPORTANT: Using '|||' delimiter to avoid issues with commas in ministry names
    function getSelectedValues(checkboxClass) {
        const dropdownId = checkboxClass === 'year-checkbox' ? 'yearDropdown' : 'ministryDropdown';
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return ""; 
        const checkboxes = dropdown.querySelectorAll(`.${checkboxClass}`);
        
        // Use '|||' as a separator
        return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value).join('|||'); 
    }
    
    window.onclick = function(event) {
        if (!event.target.closest('.multi-select-container')) {
            const yearDropdown = document.getElementById("yearDropdown");
            const ministryDropdown = document.getElementById("ministryDropdown");
            if (yearDropdown) yearDropdown.style.display = "none";
            if (ministryDropdown) ministryDropdown.style.display = "none";
        }
        if (!event.target.matches('#profileIcon')) {
            document.getElementById("profileDropdown").style.display = "none";
        }
    }

    // --- CORE DATA FUNCTIONS ---
    async function fetchData(endpoint, params={}) {
      const url = new URL(API_URL);
      url.search = new URLSearchParams({action:endpoint, ...params});
      try {
        const res = await fetch(url);
        if (!res.ok) {
           throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      } catch (error) {
        showAppMessage("API سے ڈیٹا لانے میں ناکامی۔ انٹرنیٹ کنکشن یا API کو چیک کریں۔ (Failed to fetch data from API. Check connection or API status.)");
        console.error("Fetch Error:", error);
        return []; 
      }
    }

    async function loadYears() {
      allYears = await fetchData("getYears");
      const yearDropdown = document.getElementById("yearDropdown");
      
      if (allYears.length === 0) {
        document.getElementById("selectedYearsText").innerText = "No Years Found";
        showAppMessage("سال کا ڈیٹا نہیں ملا۔ براہ کرم Google Sheet چیک کریں۔ (No Year data found. Please check Google Sheet.)");
        return;
      }

      const selectAllContainer = yearDropdown.querySelector('#selectAllYears').parentElement;
      const hr = yearDropdown.querySelector('hr');
      yearDropdown.innerHTML = '';
      yearDropdown.appendChild(selectAllContainer);
      yearDropdown.appendChild(hr);

      allYears.forEach(y => {
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" class="year-checkbox" value="${y}" onchange="updateSelectedText('yearDropdown', 'selectedYearsText', 'year-checkbox')"> ${y}`;
          yearDropdown.appendChild(label);
      });

      document.getElementById('selectAllYears').checked = true;
      toggleSelectAll('yearDropdown', 'year-checkbox');
    }
    
    async function loadMinistries() {
      const selectedYears = getSelectedValues('year-checkbox');
      const ministryDropdown = document.getElementById("ministryDropdown");

      if (!selectedYears) {
          document.getElementById("selectedMinistriesText").innerText = "No Years Selected";
          if (ministryDropdown) {
            const selectAllContainer = ministryDropdown.querySelector('#selectAllMinistries').parentElement;
            const hr = ministryDropdown.querySelector('hr');
            ministryDropdown.innerHTML = '';
            ministryDropdown.appendChild(selectAllContainer);
            ministryDropdown.appendChild(hr);
          }
          return;
      }
      
      allMinistries = await fetchData("getMinistries", {years: selectedYears}); 
      
      const selectAllContainer = ministryDropdown.querySelector('#selectAllMinistries').parentElement;
      const hr = ministryDropdown.querySelector('hr');
      ministryDropdown.innerHTML = '';
      ministryDropdown.appendChild(selectAllContainer);
      ministryDropdown.appendChild(hr);
      
      if (allMinistries.length === 0) {
        document.getElementById("selectedMinistriesText").innerText = "No Ministries Found";
        return;
      }
      
      allMinistries.forEach(m => {
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" class="ministry-checkbox" value="${m}" onchange="updateSelectedText('ministryDropdown', 'selectedMinistriesText', 'ministry-checkbox')"> ${m}`;
          ministryDropdown.appendChild(label);
      });
      
      document.getElementById('selectAllMinistries').checked = true;
      toggleSelectAll('ministryDropdown', 'ministry-checkbox');
    }

    // --- NEW FUNCTION: loadPACProgress ---
    async function loadPACProgress() {
      const selectedYears = getSelectedValues('year-checkbox');
      const selectedMinistries = getSelectedValues('ministry-checkbox');
      
      if (!selectedYears || !selectedMinistries) {
          showAppMessage("براہ کرم کم از کم ایک سال اور ایک وزارت منتخب کریں۔ (Please select at least one Year and one Ministry.)");
          return;
      }
      
      const data = await fetchData("generatePACProgress", {years: selectedYears, ministries: selectedMinistries});
      const table = document.getElementById("summary");
      currentView = "PACProgress";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='9'>No Data Found for PAC Progress Report</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "PAC Status Report (Detailed)";

      let totals = Array(9).fill(0);

      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry/ Division/ PAO</th>
          <th>Department</th>
          <th>Total paras printed in the audit report</th>
          <th>Paras discussed by the PAC</th>
          <th>Paras settled by the PAC</th>
          <th>Paras recommended for settlement by DAC, to be recommended by PAC/ Sub-Committee</th>
          <th>Paras pending with FIA/NAB/Court cases</th>
          <th>Paras pending for discussion by the PAC/ Sub-Committee</th>
        </tr>
      `;

      data.forEach(r => {
        const isTotalRow = ((r[0] || "").toUpperCase().includes("TOTAL") || (r[1] || "").toUpperCase().includes("TOTAL"));
        if (isTotalRow) return;

        table.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        
        for(let i = 3; i < 9; i++) {
            totals[i] += parseInt(r[i] || 0);
        }
      });

      table.innerHTML += `
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="3" style="text-align:right">Total</td>
          <td>${totals[3]}</td>
          <td>${totals[4]}</td>
          <td>${totals[5]}</td>
          <td>${totals[6]}</td>
          <td>${totals[7]}</td>
          <td>${totals[8]}</td>
        </tr>
      `;
    }
    
    // --- Existing functions (loadSummary, loadDACSettled, loadPendingSplit) ---
    async function loadSummary() {
      const selectedYears = getSelectedValues('year-checkbox');
      const selectedMinistries = getSelectedValues('ministry-checkbox');
      
      if (!selectedYears || !selectedMinistries) {
          showAppMessage("براہ کرم کم از کم ایک سال اور ایک وزارت منتخب کریں۔ (Please select at least one Year and one Ministry.)");
          return;
      }
      
      const data = await fetchData("generateSummary", {years: selectedYears, ministries: selectedMinistries});
      const table = document.getElementById("summary");
      currentView = "summary";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='8'>No Data Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Workload Summary";

      let totals = { total:0, pac:0, dac:0, pending:0 };

      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Department</th>
          <th>Total Paras</th>
          <th>PAC Settled</th>
          <th>DAC Settled</th>
          <th>Pending</th>
          <th>Pending Para Nos</th>
        </tr>
      `;

      data.forEach(r => {
        const isTotalRow = ((r[0] || "").toUpperCase().includes("TOTAL") || (r[1] || "").toUpperCase().includes("TOTAL"));
        if (isTotalRow) return;

        table.innerHTML += `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        totals.total += parseInt(r[3]||0);
        totals.pac += parseInt(r[4]||0);
        totals.dac += parseInt(r[5]||0);
        totals.pending += parseInt(r[6]||0);
      });

      table.innerHTML += `
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="3" style="text-align:right">Total</td>
          <td>${totals.total}</td>
          <td>${totals.pac}</td>
          <td>${totals.dac}</td>
          <td>${totals.pending}</td>
          <td></td>
        </tr>
      `;
    }

    async function loadPendingSplit() {
      const selectedYears = getSelectedValues('year-checkbox');
      const selectedMinistries = getSelectedValues('ministry-checkbox');
      
      if (!selectedYears || !selectedMinistries) {
          showAppMessage("براہ کرم کم از کم ایک سال اور ایک وزارت منتخب کریں۔ (Please select at least one Year and one Ministry.)");
          return;
      }

      const data = await fetchData("generateSummary", {years: selectedYears, ministries: selectedMinistries});
      const table = document.getElementById("summary");
      currentView = "pendingSplit";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='10'>No Data Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Workload Summary (Detailed)";

      let totals = { total:0, pac:0, dac:0, pAudit:0, pComments:0 };

      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Entity</th>
          <th>Total Paras</th>
          <th>PAC Settled</th>
          <th>DAC Settled</th>
          <th>Pending Audit Paras</th>
          <th>Pending Audit Paras Nos</th>
          <th>Pending Audit Comments</th>
          <th>Pending Audit Comments Nos</th>
        </tr>
      `;

      data.forEach(r => {
        const isTotalRow = ((r[0] || "").toUpperCase().includes("TOTAL") || (r[1] || "").toUpperCase().includes("TOTAL"));
        if (isTotalRow) return;

        const year = r[0], min = r[1], dept = r[2];
        const total = parseInt(r[3]||0), pac = parseInt(r[4]||0), dac = parseInt(r[5]||0);
        let pendingNos = (r[7]||"").split(",").map(p=>p.trim()).filter(p=>p);

        let pAudit = [], pComments = [];
        pendingNos.forEach(p=>{
          if (/^\d+(\.\d+)*\.4\.\d+$/.test(p)) { 
            pAudit.push(p);
          } else {
            pComments.push(p);
          }
        });

        table.innerHTML += `
          <tr>
            <td>${year}</td>
            <td>${min}</td>
            <td>${dept}</td>
            <td>${total}</td>
            <td>${pac}</td>
            <td>${dac}</td>
            <td>${pAudit.length}</td>
            <td>${pAudit.join(", ")}</td>
            <td>${pComments.length}</td>
            <td>${pComments.join(", ")}</td>
          </tr>
        `;

        totals.total += total; totals.pac += pac; totals.dac += dac;
        totals.pAudit += pAudit.length; totals.pComments += pComments.length;
      });

      table.innerHTML += `
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="3" style="text-align:right">Total</td>
          <td>${totals.total}</td>
          <td>${totals.pac}</td>
          <td>${totals.dac}</td>
          <td>${totals.pAudit}</td>
          <td></td>
          <td>${totals.pComments}</td>
          <td></td>
        </tr>
      `;
    }

    async function loadDACSettled() {
      const selectedYears = getSelectedValues('year-checkbox');
      const selectedMinistries = getSelectedValues('ministry-checkbox');
      
      if (!selectedYears || !selectedMinistries) {
          showAppMessage("براہ کرم کم از کم ایک سال اور ایک وزارت منتخب کریں۔ (Please select at least one Year and one Ministry.)");
          return;
      }

      const data = await fetchData("dacSettled", {years: selectedYears, ministries: selectedMinistries});
      const table = document.getElementById("summary");
      currentView = "dac";

      if (!data.length) {
        table.innerHTML = "<tr><td colspan='6'>No DAC Settled Paras Found</td></tr>";
        return;
      }

      document.getElementById("printHeading").innerText = "Summary of Paras Settled in DAC";

      let totalDAC = 0;
      table.innerHTML = `
        <tr>
          <th>Year</th>
          <th>Ministry</th>
          <th>Entity</th>
          <th>Date of DAC</th>
          <th>Paras Settled in DAC</th>
          <th>Settled Para Nos</th>
        </tr>
        ${data.map(r => {
          totalDAC += parseInt(r[4] || 0, 10);
          return `<tr>${r.map(c => `<td>${c}</td>`).join("")}</tr>`;
        }).join("")}
        <tr style="font-weight:bold;background:#f2f2f2;">
          <td colspan="4" style="text-align:right">Total</td>
          <td>${totalDAC}</td>
          <td></td>
        </tr>
      `;
    }

    function printTable() { window.print(); }

    function downloadExcel() {
      const table = document.getElementById("summary");
      const wb = XLSX.utils.table_to_book(table, {sheet:"Summary"});
      let filename = "Workload_Summary.xlsx";
      if (currentView === "dac") filename = "DAC_Settled_Summary.xlsx";
      if (currentView === "pendingSplit") filename = "Workload_Detailed_Summary.xlsx";
      if (currentView === "PACProgress") filename = "PAC_Status_Report.xlsx";
      XLSX.writeFile(wb, filename);
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'pt', 'a4');
      const title = document.getElementById("printHeading").innerText;
      doc.text(title, 40, 30);
      doc.autoTable({ html: '#summary', startY: 50 });
      let filename = "Workload_Summary.pdf";
      if (currentView === "dac") filename = "DAC_Settled_Summary.pdf";
      if (currentView === "pendingSplit") filename = "Workload_Detailed_Summary.pdf";
      if (currentView === "PACProgress") filename = "PAC_Status_Report.pdf";
      doc.save(filename);
    }
  </script>
</body>
</html>
